name: publish to dev

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout git repos
      ##########################################################################
      
      # https://github.com/actions/checkout/tree/v4
      - name: ‚úîÔ∏è checkout xo.codes source
        uses: actions/checkout@v4
        with:
          repository: '${{ github.repository }}'
          ref: 'main'
          path: 'main'
          lfs: true
          show-progress: false
      
      # https://github.com/actions/checkout/tree/v4
      - name: ‚úîÔ∏è checkout dev.xo.codes static site
        uses: actions/checkout@v4
        with:
          token: '${{ secrets.PAT }}'
          repository: '${{ github.repository }}'
          ref: 'www-dev'
          path: 'www-dev'
          lfs: true
          show-progress: false
          
      # https://github.com/actions/checkout/tree/v4
      - name: ‚úîÔ∏è checkout markdeep-static tool
        uses: actions/checkout@v4
        with:
          repository: 'xoorath/markdeep-static'
          token: '${{ github.token }}'
          ref: 'main'
          path: 'markdeep-static'
          submodules: true
          show-progress: false

      # run site generation
      ##########################################################################

      - uses: actions/setup-node@v5
        with:
          node-version: '22.x'
      
      - name: üçï install npm dependencies
        working-directory: markdeep-static
        run: npm install

      - name: üõ°Ô∏è Disable AppArmor
        run: echo 0 | sudo tee /proc/sys/kernel/apparmor_restrict_unprivileged_userns

      - name: üçï run site generation
        working-directory: markdeep-static
        run: node app.js --in="../main/site" --out="../www-dev" --options="../main/markdeep-options.json"

      # submit results
      ##########################################################################

      - name: ‚û°Ô∏è commit to www-dev
        working-directory: www-dev
        run: |
          git config user.email "769014+xoorath@users.noreply.github.com"
          git config user.name "xoorath [bot]"
          git add .
          git commit -m "ü§ñ updating static site from ${{ github.run_id }}"

      - name: ‚§¥Ô∏è push www-dev
        working-directory: www-dev
        run: git push origin www-dev
